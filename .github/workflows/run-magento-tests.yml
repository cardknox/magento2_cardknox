name: Magento2 Build, PHPUnit Tests & PHP CodeSniffer

on:
  push:
    branches-ignore:
      - 'master'
      - 'rc/*/*/*'
  pull_request:
    types:
      - opened

jobs:
  magento2-build:
    runs-on: ubuntu-latest
    name: Magento2 Build, PHPUnit Tests & PHP CodeSniffer

    services:
      mysql:
        image: docker://mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: magento
          MYSQL_DATABASE: magento
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      opensearch:
        image: ghcr.io/mad-i-t/magento-opensearch:2.5.0
        ports:
          - 9200:9200
        options: -e="discovery.type=single-node" -e "plugins.security.disabled=true" -e "plugins.security.ssl.http.enabled=false" --health-cmd="curl http://localhost:9200/_cluster/health" --health-interval=10s --health-timeout=5s --health-retries=10

    steps:
    - uses: actions/checkout@v3
      with:
        path: Cardknox

    # Add PHP setup step
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: mbstring, intl, gd, xml, soap, zip, bcmath, opcache, pdo_mysql, curl, dom, hash, iconv, json, simplexml, xsl, xmlreader, xmlwriter, session
        tools: composer:v2

    - name: Download Magento Directly
      run: |
        # Download Magento 2.4.8-p3 from GitHub
        wget https://github.com/magento/magento2/archive/2.4.8-p3.zip
        unzip 2.4.8-p3.zip
        mv magento2-2.4.8-p3 magento

    - name: Install Dependencies
      run: |
        cd magento
        composer install --no-interaction --prefer-dist
        # Install Magento2 Coding Standard for PHPCS
        composer require --dev magento/magento-coding-standard --no-interaction

    - name: Create Directories for Cardknox Module
      run: |
        mkdir -p magento/app/code/CardknoxDevelopment

    - name: Move Cardknox Module
      run: |
        mv Cardknox magento/app/code/CardknoxDevelopment

    - name: Enable Cardknox module
      run: |
        sudo php magento/bin/magento module:enable CardknoxDevelopment_Cardknox --clear-static-content
        sudo php magento/bin/magento setup:di:compile
        sudo chmod -R 777 magento/generated/ magento/var/ magento/pub/
        sudo php magento/bin/magento module:status

    - name: Run Unit Tests
      run: |
        cd magento
        # Remove Allure bootstrap to avoid config file warning
        sed -i '/<bootstrap class="Qameta\\Allure\\PHPUnit\\AllureExtension">/,/<\/bootstrap>/d' dev/tests/unit/phpunit.xml.dist
        php vendor/phpunit/phpunit/phpunit -c dev/tests/unit/phpunit.xml.dist app/code/CardknoxDevelopment/Cardknox/Test/

    - name: Run PHP CodeSniffer (PHPCS)
      run: |
        cd magento
        vendor/bin/phpcs --standard=Magento2 \
          --extensions=php,phtml \
          --report=full \
          app/code/CardknoxDevelopment/Cardknox/

name: m2-actions-test
on: 
  push:
    branches-ignore: 
      - 'master'
      - 'rc/*/*/*'
      
jobs:
  magento2-build:
    runs-on: ubuntu-latest
    name: 'm2 unit tests & build'
    services:
      mysql:
        image: docker://mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: magento
          MYSQL_DATABASE: magento
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      #elasticsearch:
        #image: docker://elasticsearch:7.1.0
        #ports:
        #  - 9200:9200
        #options: -e="discovery.type=single-node" --health-cmd="curl http://localhost:9200/_cluster/health" --health-interval=10s --health-timeout=5s --health-retries=10
      opensearch:
        image: ghcr.io/mad-i-t/magento-opensearch:2.5.0
        ports:
          - 9200:9200
        options: -e="discovery.type=single-node" -e "plugins.security.disabled=true" -e "plugins.security.ssl.http.enabled=false" --health-cmd="curl http://localhost:9200/_cluster/health" --health-interval=10s --health-timeout=5s --health-retries=10
     
    steps:
    - uses: actions/checkout@v3
      with:
        path: app/code/CardknoxDevelopment_Cardknox

    - name: Install Magento
      uses: MAD-I-T/magento-actions@v3.20
      with:
        process: 'install-mage-os'
        magento_version: 2.4.4
        no_push: 1
    
    #- name: Setup PHP
    #  uses: shivammathur/setup-php@v2
    
    - name: Install Dependencies
      run: |
        cd app/code/CardknoxDevelopment_Cardknox
        sudo composer install
      #  echo CHANGING TO CARDKNOX ---------------
      #  cd magento/app/code/CardknoxDevelopment/Cardknox
      #  ls
      #  pwd
    
    - name: Install Dependencies
      run: |
        cd magento
        sudo composer install

    - name: Check Magento APP Paths
      run: |
        pwd
        ls
        echo CHANGING TO APP ---------------
        cd app
        ls
        echo CHANGING TO code ---------------
        cd code
        ls
        echo CHANGING TO CardknoxDevelopment_Cardknox ---------------
        cd CardknoxDevelopment_Cardknox
        ls

    - name: Run Unit Tests
      run: |
        sudo php magento/vendor/phpunit/phpunit/phpunit -c magento/dev/tests/unit/phpunit.xml.dist app/code/CardknoxDevelopment_Cardknox/Test

    - name: Compile Magento
      run: |
        sudo php magento/bin/magento module:status
        sudo php magento/bin/magento module:enable CardknoxDevelopment_Cardknox --clear-static-content
        sudo php magento/bin/magento setup:upgrade
      #  composer update
      #         sudo php bin/magento setup:di:compile
      #  sudo php bin/magento deploy:mode:set developer
      #  sudo php bin/magento config:set dev/template/allow_symlink 1 --lock-env
        
      #  sudo php bin/magento module:enable --all
      #  sudo composer install
      #  sudo php bin/magento setup:upgrade
      #  sudo php bin/magento setup:install --base-url=http://127.0.0.1:3306/  --db-host=localhost --db-name=magento --db-user=root --db-password=magento  --admin-firstname=admin --admin-lastname=admin --admin-email=admin@admin.com --admin-user=admin --admin-password=admin123 --language=en_US  --currency=USD --timezone=America/Chicago --use-rewrites=1


    - name: Check Paths
      run: |
        pwd
        ls
        echo CHANGING TO MAGENTO ---------------
        cd magento
        ls
        echo CHANGING TO VENDER ---------------
        cd vendor
        ls
        echo CHANGING TO PHPUNIT ---------------
        cd phpunit
        ls
        echo CHANGING TO PHPUNIT ---------------
        cd phpunit
        ls

    - name: Check Paths2
      run: |
        pwd
        ls
        echo CHANGING TO VENDER ---------------
        cd vendor
        ls
        echo CHANGING TO PHPUNIT ---------------
        cd phpunit
        ls
        echo CHANGING TO PHPUNIT ---------------
        cd phpunit
        ls

    - name: Run Unit Tests
      run: |
        php magento/vendor/phpunit/phpunit/phpunit -c magento/dev/tests/unit/phpunit.xml.dist app/code/CardknoxDevelopment_Cardknox/Test
        
    #- name: 'this step will build an magento artifact'
    #  uses: MAD-I-T/magento-actions@v3.20
    #  with:
    #    process: 'build'
        
    #- name: 'Run Magento unit tests'
    #  uses: MAD-I-T/magento-actions@v3.20
    #  with:
    #    process: 'unit-test'
    #    unit_test_subset_path: '../Test/'
      #  unit_test_config: 'dev/tests/unit/phpunit.xml.dist'
        
